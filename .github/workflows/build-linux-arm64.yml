name: Build Plugin (Linux ARM64)

on:
  workflow_dispatch:  # 仅允许手动触发

jobs:
  build:
    # Use Windows runner to avoid Resource.Embedder path issues on Linux
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 只获取最新提交，加快克隆速度

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.x'

      # 缓存NuGet包，大幅提升构建速度
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore StrmAssistant/StrmAssistant.csproj -r linux-arm64

      - name: Build the project for Linux ARM64
        run: dotnet build StrmAssistant/StrmAssistant.csproj --no-restore --configuration Release -r linux-arm64 --no-self-contained -p:UseSharedCompilation=false
        # Note: Building for linux-arm64 on Windows runner to avoid Resource.Embedder issues
        # PostBuild target may fail (Windows-specific paths), but we'll merge DLLs manually in the next step

      - name: List all DLLs in output directory
        run: |
          $TARGET_DIR = "StrmAssistant\bin\Release\net6.0\linux-arm64"
          Write-Host "=== All DLLs in build output ==="
          Get-ChildItem -Path $TARGET_DIR -Filter "*.dll" | Sort-Object Name | ForEach-Object { Write-Host $_.FullName }
          Write-Host ""
          Write-Host "=== DLLs that will be merged (matching Windows build) ==="
          Write-Host "- StrmAssistant.dll (main DLL)"
          Write-Host "- 0Harmony.dll (from Lib.Harmony package)"
          Write-Host "- ChineseConverter.dll (from CHTCHSConv package)"
          Write-Host "- TinyPinyin.dll (from TinyPinyin package)"
          Write-Host ""
          Write-Host "Note: Other DLLs (Emby framework, System.*, etc.) are not merged as they're provided by Emby server"

      - name: Merge DLLs using ILRepack
        run: |
          # 查找ILRepack.exe
          $ILREPACK_EXE = Get-ChildItem -Path "$env:USERPROFILE\.nuget\packages" -Recurse -Filter "ILRepack.exe" | Select-Object -First 1
          
          if (-not $ILREPACK_EXE -or -not (Test-Path $ILREPACK_EXE.FullName)) {
            Write-Host "Error: ILRepack.exe not found in NuGet packages"
            exit 1
          }
          
          Write-Host "Found ILRepack at: $($ILREPACK_EXE.FullName)"
          
          # 创建输出目录 (使用临时目录，稍后上传)
          $OUTPUT_DIR = "$env:RUNNER_TEMP\linux-arm64-build"
          New-Item -ItemType Directory -Path $OUTPUT_DIR -Force | Out-Null
          
          # 构建ILRepack命令 - 匹配Windows PostBuild配置
          $TARGET_DIR = "StrmAssistant\bin\Release\net6.0\linux-arm64"
          $OUTPUT_FILE = "$OUTPUT_DIR\StrmAssistant.dll"
          
          # 检查所有必需的DLL是否存在 (匹配Windows build的PostBuild目标)
          $MISSING_DLLS = @()
          if (-not (Test-Path "$TARGET_DIR\StrmAssistant.dll")) {
            $MISSING_DLLS += "StrmAssistant.dll"
          }
          if (-not (Test-Path "$TARGET_DIR\0Harmony.dll")) {
            $MISSING_DLLS += "0Harmony.dll"
          }
          if (-not (Test-Path "$TARGET_DIR\ChineseConverter.dll")) {
            $MISSING_DLLS += "ChineseConverter.dll"
          }
          if (-not (Test-Path "$TARGET_DIR\TinyPinyin.dll")) {
            $MISSING_DLLS += "TinyPinyin.dll"
          }
          
          if ($MISSING_DLLS.Count -gt 0) {
            Write-Host "Error: Required DLLs not found:"
            foreach ($dll in $MISSING_DLLS) {
              Write-Host "  - $dll"
            }
            exit 1
          }
          
          Write-Host "Merging DLLs (matching Windows PostBuild configuration)..."
          # 运行ILRepack合并DLL - 完全匹配Windows .csproj中的PostBuild命令
          & $ILREPACK_EXE.FullName /out:"$OUTPUT_FILE" `
            "$TARGET_DIR\StrmAssistant.dll" `
            "$TARGET_DIR\0Harmony.dll" `
            "$TARGET_DIR\ChineseConverter.dll" `
            "$TARGET_DIR\TinyPinyin.dll" `
            /lib:"$TARGET_DIR"
          
          # 验证输出文件
          if (Test-Path $OUTPUT_FILE) {
            Write-Host "Successfully created merged DLL: $OUTPUT_FILE"
            Get-Item $OUTPUT_FILE | Format-List
            Write-Host ""
            Write-Host "Merged DLL includes:"
            Write-Host "  - StrmAssistant.dll (main)"
            Write-Host "  - 0Harmony.dll"
            Write-Host "  - ChineseConverter.dll"
            Write-Host "  - TinyPinyin.dll"
          } else {
            Write-Host "Error: Merged DLL was not created"
            exit 1
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: StrmAssistant-linux-arm64-${{ github.run_number }}
          path: ${{ runner.temp }}\linux-arm64-build\StrmAssistant.dll
          compression-level: 0  # DLL已经是二进制，不需要压缩
          retention-days: 30
